# Story 4.1.11: MultiStep Form Step 1 Implementation

**Status:** Draft  
**Priority:** High  
**Estimated Effort:** 3-4 hours  
**Dependencies:** Story 4.1.8 (MultiStepForm Controller) ✅ COMPLETED, Story 4.1.9 (Step Renderer Configuration) ✅ COMPLETED

## Story

**As a** sustainability reporting user,  
**I want** to complete the first step of the General Information form with company details,  
**so that** I can provide essential company information through a validated, testable single-step implementation that lays the foundation for the multi-step form system.

## Story Context

**Strategic Approach:**
- First incremental implementation of the failed 4.1.10 story
- Focus on single step implementation with full test coverage
- Builds on existing test page form demonstrations
- Establishes pattern for subsequent steps

**Implementation Strategy:**
- Start with Step 1 (Company Information) only
- Full TDD approach with tests written first
- Integration with existing MultiStepForm and StepRenderer
- Use existing field components from /test page demos

## Acceptance Criteria

1. GeneralInfo page renders MultiStepForm with ONLY Step 1 (Company Information) configured
2. Step 1 includes all company fields: name, organization number, country, NACE code, industry, revenue, balance sheet value, employees, contact person name, contact person email
3. All fields have proper Zod validation schemas with appropriate rules
4. Form data persists to localStorage with key `form-general-info-step1`
5. Form restores data correctly on page reload
6. Validation prevents form submission until all required fields are complete
7. Tests are written BEFORE implementation following TDD principles
8. All tests pass for field rendering, validation, and persistence
9. TypeScript compilation passes with full type safety
10. Form follows existing component patterns from test page demos
11. "Next" button is disabled/hidden since this is a single-step implementation
12. Form displays "Save Draft" and "Complete Step 1" buttons instead of standard navigation

## Tasks / Subtasks

- [ ] **Task 1: Write Tests First (TDD)** (AC: 7)
  - [ ] Create test file for GeneralInfo Step 1 configuration
  - [ ] Write tests for field rendering and structure
  - [ ] Write tests for validation rules
  - [ ] Write tests for localStorage persistence
  - [ ] Write tests for data restoration
  - [ ] Verify all tests fail initially (Red phase)

- [ ] **Task 2: Create Step 1 Form Configuration** (AC: 1, 2, 3)
  - [ ] Create `apps/web/src/lib/forms/types/general-info-step1-types.ts` with GeneralInfoStep1Data interface
  - [ ] Create `apps/web/src/lib/forms/validation/general-info-step1-schemas.ts` with Zod schemas
  - [ ] Create `apps/web/src/lib/forms/configs/general-info-step1-config.ts` with form configuration
  - [ ] Define GeneralInfoStep1Data TypeScript interface
  - [ ] Create Zod schema for company information fields
  - [ ] Create form configuration with single step
  - [ ] Map fields to existing field registry components

- [ ] **Task 3: Implement GeneralInfo Page Integration** (AC: 1, 5, 6, 11, 12)
  - [ ] Update GeneralInfo page to use MultiStepForm
  - [ ] Configure with Step 1 only configuration
  - [ ] Set up localStorage key `form-general-info-step1` for persistence
  - [ ] Disable/hide "Next" button, add "Save Draft" and "Complete Step 1" buttons
  - [ ] Maintain existing page layout structure

- [ ] **Task 4: Make Tests Pass (Green phase)** (AC: 8, 9)
  - [ ] Run tests and fix implementation issues
  - [ ] Ensure all field validations work
  - [ ] Verify persistence and restoration
  - [ ] Confirm TypeScript compilation

- [ ] **Task 5: Refactor and Optimize** (AC: 10)
  - [ ] Review code for patterns from test page
  - [ ] Optimize for performance if needed
  - [ ] Add appropriate code comments
  - [ ] Ensure consistent code style

## Dev Notes

### Previous Story Context (4.1.10 Failure)
- Story 4.1.10 attempted full multi-step implementation at once
- Implementation was too complex without incremental testing
- Decision made to split into 3 progressive stories for TDD approach

### Form Configuration Structure
Based on existing MultiStepForm patterns from Stories 4.1.8 & 4.1.9:
```typescript
interface MultiStepFormConfig<T> {
  id: string
  title: string
  steps: FormStep<T>[]
  onSubmit: (data: T) => Promise<void>
  storage?: StorageProvider
}
```
[Source: Story 4.1.10 documentation]

### Step 1 Fields Required
Company Information fields from original story:
- Company name (text, required)
- Organization number (text, required)
- Country (select, required)
- NACE code (text, required)
- Industry (select, required)
- Revenue (number, required)
- Balance sheet value (number, required)
- Number of employees (number, required)
- Contact person name (text, required)
- Contact person email (email, required)

### Field Validation Rules

- **Company name**: Required, min 2 characters, max 100 characters
- **Organization number**: Required, format: XX-XXXXXXXX (regex: /^\d{2}-\d{8}$/)
- **Country**: Required, select from predefined list
- **NACE code**: Required, format: XX.XX (regex: /^\d{2}\.\d{2}$/)
- **Industry**: Required, select from predefined list
- **Revenue**: Required, number, min: 0, max: 999999999999
- **Balance sheet value**: Required, number, min: 0, max: 999999999999
- **Number of employees**: Required, integer, min: 1, max: 999999
- **Contact person name**: Required, min 2 characters, max 100 characters
- **Contact person email**: Required, valid email format

### Select Field Options

**Country Options:**
- Norway
- Sweden  
- Denmark
- Finland
- Iceland
- Germany
- United Kingdom
- Netherlands
- France
- Other

**Industry Options:**
- Manufacturing
- Services
- Retail
- Technology
- Healthcare
- Finance
- Construction
- Transportation
- Energy
- Agriculture
- Other

### File Locations
Based on project structure:
- Form config: `apps/web/src/lib/forms/configs/general-info-step1-config.ts`
- Types: `apps/web/src/lib/forms/types/general-info-step1-types.ts`
- Validation: `apps/web/src/lib/forms/validation/general-info-step1-schemas.ts`
- Page update: `apps/web/src/app/(SignedIn)/generalinfo/page.tsx`
- Tests: `apps/web/src/app/(SignedIn)/generalinfo/__tests__/step1.test.tsx`

### localStorage Key Decision
Using `form-general-info-step1` to avoid conflicts with future multi-step implementations. This allows:
- Independent testing of Step 1 functionality
- No interference with stories 4.1.12 and 4.1.13 implementations
- Clear separation during incremental development

### Existing Components to Use
From test page demonstrations:
- MultiStepForm: `apps/web/src/components/forms/multi-step/MultiStepForm.tsx`
- StepRenderer: `apps/web/src/components/forms/multi-step/StepRenderer.tsx`
- Field components from registry as shown in test page

### Example Configuration Structure

```typescript
// Example configuration structure for Step 1
const step1Config: FormStep<GeneralInfoStep1Data> = {
  id: 'company-info',
  title: 'Company Information',
  fields: [
    {
      type: 'text',
      name: 'companyName',
      label: 'Company Name',
      required: true,
      validation: generalInfoStep1Schema.shape.companyName
    },
    {
      type: 'text',
      name: 'organizationNumber',
      label: 'Organization Number',
      placeholder: 'XX-XXXXXXXX',
      required: true,
      validation: generalInfoStep1Schema.shape.organizationNumber
    },
    {
      type: 'select',
      name: 'country',
      label: 'Country',
      required: true,
      options: countryOptions,
      validation: generalInfoStep1Schema.shape.country
    },
    // ... more fields following same pattern
  ]
}
```

### Testing Requirements

**Test File Location:** 
- `apps/web/src/app/(SignedIn)/generalinfo/__tests__/step1.test.tsx`

**Test Standards:**
- Use Vitest with React Testing Library
- Follow TDD red-green-refactor cycle
- Test field rendering, validation, and persistence
- Mock localStorage for persistence tests
- Use existing test patterns from project

**Testing Framework:**
- Vitest for test runner
- React Testing Library for component testing
- MSW for API mocking if needed
- jest-axe for accessibility

### Required Test Scenarios

1. **Field Rendering Tests:**
   - All 10 fields render correctly
   - Field labels match specifications
   - Required field indicators present

2. **Validation Tests:**
   - Each field validates according to rules
   - Form prevents submission with invalid data
   - Error messages display correctly

3. **Persistence Tests:**
   - Data saves to localStorage on change
   - Data restores on page reload
   - localStorage key is correct (`form-general-info-step1`)

4. **Edge Case Tests:**
   - Empty form submission blocked
   - Partial data saves correctly
   - Special characters handled properly

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-26 | 1.0 | Initial story creation - Split from 4.1.10 for TDD implementation | Bob (Scrum Master) |
| 2025-08-26 | 1.1 | Updated based on PO validation feedback - Added validation rules, field options, and test scenarios | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled during implementation*

### Debug Log References
*To be filled during implementation*

### Completion Notes List
*To be filled during implementation*

### File List
*To be filled during implementation*

## QA Results

*QA review results will be documented here after implementation*
