# Story 4.1.12: MultiStep Form Step 2 Implementation

**Status:** Draft  
**Priority:** High  
**Estimated Effort:** 3-4 hours  
**Dependencies:** Story 4.1.11 (Step 1 Implementation) âœ… COMPLETED

## Story

**As a** sustainability reporting user,  
**I want** to add the second step for Strategy & Governance to the existing single-step form,  
**so that** I can provide strategic sustainability information in a properly validated multi-step experience with seamless navigation between steps.

## Story Context

**Strategic Approach:**
- Second incremental implementation building on Step 1
- Adds multi-step navigation functionality
- Continues TDD approach with test-first development
- Tests step transitions and data persistence across steps

**Implementation Strategy:**
- Extend Step 1 implementation to include Step 2
- Add navigation between steps with validation
- Ensure data persists across step navigation
- Full test coverage for multi-step behavior

## Acceptance Criteria

1. GeneralInfo form now includes both Step 1 (Company Info) AND Step 2 (Strategy & Governance)
2. Step 2 includes strategy fields: sustainability strategy, governance structure, risk management
3. Navigation controls allow movement between Step 1 and Step 2
4. Step 1 validation must pass before proceeding to Step 2
5. Form data persists across step navigation with key `form-general-info`
6. Progress indicator shows current step (1 of 2 or 2 of 2)
7. Back navigation from Step 2 to Step 1 preserves all entered data
8. Tests written BEFORE implementation for Step 2 functionality
9. All tests pass for multi-step navigation and validation
10. TypeScript compilation passes with extended types

## Tasks / Subtasks

- [ ] **Task 1: Write Tests for Step 2 (TDD)** (AC: 8)
  - [ ] Create tests for Step 2 field rendering
  - [ ] Write tests for Step 2 validation rules
  - [ ] Write tests for step navigation forward/back
  - [ ] Write tests for validation blocking navigation
  - [ ] Write tests for data persistence across steps
  - [ ] Verify tests fail initially (Red phase)

- [ ] **Task 2: Extend Form Configuration for Step 2** (AC: 1, 2, 3)
  - [ ] Update GeneralInfoData interface to include Step 2 fields
  - [ ] Create Zod schema for strategy & governance fields
  - [ ] Update form configuration to include Step 2
  - [ ] Configure step navigation rules

- [ ] **Task 3: Implement Multi-Step Navigation** (AC: 3, 4, 6, 7)
  - [ ] Enable NavigationControls in form configuration
  - [ ] Implement step validation before navigation
  - [ ] Add ProgressIndicator to show current step
  - [ ] Ensure back navigation preserves data

- [ ] **Task 4: Update Data Persistence** (AC: 5)
  - [ ] Update localStorage key to handle both steps
  - [ ] Ensure data saves on step navigation
  - [ ] Test restoration of multi-step data
  - [ ] Handle partial data scenarios

- [ ] **Task 5: Make All Tests Pass** (AC: 9, 10)
  - [ ] Fix implementation to pass Step 2 tests
  - [ ] Ensure navigation tests pass
  - [ ] Verify persistence tests pass
  - [ ] Confirm TypeScript compilation

- [ ] **Task 6: Integration Testing** (AC: 1, 9)
  - [ ] Test complete flow from Step 1 to Step 2
  - [ ] Verify all validations work correctly
  - [ ] Test edge cases in navigation
  - [ ] Ensure consistent user experience

## Dev Notes

### Previous Story Context (4.1.11 Completion)
- Step 1 successfully implemented with TDD approach
- Single step form with company information fields
- localStorage persistence established with `form-general-info-step1` key
- Test patterns established for form validation
- QA Gate: PASS (Quality Score: 85/100)
- Foundation architecture ready for multi-step extension

### Form Configuration Updates
Extending existing configuration to add Step 2:
```typescript
interface GeneralInfoData {
  // Step 1 fields (existing)
  companyInfo: {
    name: string
    organizationNumber: string
    // ... other fields
  }
  // Step 2 fields (new)
  businessModel: {
    sustainabilityStrategy: string
    businessModel: string
    subsidiaries: boolean
    subsidiariesList: []
  }
}

const fieldDefinition: FieldDefinition = {
    name: 'subsidiaries',
    type: 'fieldArray',
    label: 'Subsidiaries',
    required: false,
    arrayItemSchema: subsidiarySchema,
  }

// Subsidiary schema for validation
const subsidiarySchema = z.object({
  name: z.string().min(1, 'Subsidiary name is required'),
  organizationNumber: z.string().min(1, 'Organization number is required'),
  address: z.string().min(1, 'Address is required'),
})

// Form data schema
const formSchema = z.object({
  subsidiaries: z.array(subsidiarySchema).min(0).max(5),
})
```

### Step 2 Fields Required
Strategy & Governance fields:
- Sustainability strategy description (textarea, required, min 10 chars)
- Business model description (textarea, required, min 50 chars)
- Individual/consolidated report (radio group, Individual is default)
- - Name, Organization Number, Address (text, required)

### Existing components to use as template
- FieldArrayDemo.tsx
- If the radio is selcted as Consolidated, show the fields 
-  - Name, Organization Number, Address (text, required)

### Navigation Implementation
Based on existing NavigationControls from Stories 4.1.8 & 4.1.9:
- Use existing NavigationControls component
- Implement canGoToNextStep validation logic
- Add ProgressIndicator component integration
- Handle step transition animations if configured

### File Updates Required
- Update: `apps/web/src/lib/forms/configs/general-info-config.ts` (rename from step1)
- Update: `apps/web/src/lib/forms/types/general-info-types.ts`
- Update: `apps/web/src/lib/forms/validation/general-info-schemas.ts`
- Update: `apps/web/src/app/(SignedIn)/generalinfo/page.tsx`
- Create: `apps/web/src/app/(SignedIn)/generalinfo/__tests__/step2.test.tsx`
- Update: `apps/web/src/app/(SignedIn)/generalinfo/__tests__/navigation.test.tsx`

### Testing

**Testing Framework:**
- **Primary**: Vitest with React Testing Library (following project standards)
- **Component Testing**: @testing-library/react for component interactions
- **User Events**: @testing-library/user-event for user interaction simulation
- **Mocking**: Vitest native mocking for localStorage and external dependencies
- **Accessibility**: jest-axe for WCAG 2.1 AA compliance validation

**Test File Locations:**
- `apps/web/src/app/(SignedIn)/generalinfo/__tests__/step2.test.tsx` - Step 2 specific field and validation tests
- `apps/web/src/app/(SignedIn)/generalinfo/__tests__/navigation.test.tsx` - Multi-step navigation and flow tests
- `apps/web/src/app/(SignedIn)/generalinfo/__tests__/step1.test.tsx` - Extend existing Step 1 tests for multi-step compatibility

**Test Standards:**
- **TDD Methodology**: RED-GREEN-REFACTOR cycle (tests written before implementation)
- **Coverage Requirements**: Minimum 80% coverage for new multi-step functionality
- **Test Levels**: Unit tests for validation logic, Integration tests for navigation, E2E tests for critical user journeys
- **Risk-Based Testing**: Focus on Critical Risk (DATA-001: Data Loss During Navigation) with 4 dedicated test scenarios
- **Environment**: jsdom with React 19 compatibility considerations (manual testing fallback if needed)

**Test Scenarios Priority (Based on Risk Analysis):**

**P0 Tests (Critical - Must Pass):**
- Multi-step data persistence across navigation (mitigates DATA-001 critical risk)
- Step validation blocking invalid navigation progression
- Forward and backward navigation with data preservation
- Form state consistency during step transitions

**P1 Tests (Important - Should Pass):**
- Step 2 field rendering and validation
- Progress indicator accuracy
- User experience validation (clear error messages, intuitive navigation)
- Data restoration after page refresh

**P2 Tests (Secondary - Could Pass):**
- Edge cases: rapid navigation, special characters, large data sets
- Performance: form rendering speed with multiple steps
- Accessibility: keyboard navigation, screen reader compatibility

**Coverage Requirements:**
- **All 10 Acceptance Criteria** must have corresponding test scenarios
- **Risk Mitigation**: Critical and High risks must have dedicated test coverage
- **Navigation Logic**: 100% coverage for step transition logic
- **Data Persistence**: 100% coverage for localStorage operations
- **Validation Rules**: All Step 2 field validations must be tested

**Test Environment Considerations:**
- **Known Issue**: React 19 + JSDOM compatibility issues may block some automated tests
- **Mitigation**: Manual testing protocols prepared for blocked scenarios
- **Alternative**: Playwright integration available for critical E2E tests if Vitest fails
- **Mock Strategy**: localStorage, window object, and form validation mocked for reliable test execution

**Success Criteria:**
- All P0 tests must pass for deployment approval
- 80% of P0+P1 tests passing for quality gate
- Risk mitigation tests (DATA-001) must have 100% pass rate
- TDD process validation: tests written and failing before implementation begins

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-26 | 1.0 | Initial story creation - Second split from 4.1.10 for TDD | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled during implementation*

### Debug Log References
*To be filled during implementation*

### Completion Notes List
*To be filled during implementation*

### File List
*To be filled during implementation*

## QA Results

*QA review results will be documented here after implementation*
