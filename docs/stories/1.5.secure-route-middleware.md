# Story 1.5: Secure Route Middleware

## Status
Draft

## Story
**As a** developer,
**I want** to create or update a middleware that leverages Clerk's authMiddleware,
**so that** access to protected routes is restricted to authenticated users only.

## Acceptance Criteria
1. Create or update middleware in apps/web/ (e.g., middleware.ts) to use Clerk's authMiddleware.
2. Configure the middleware to protect specified routes (e.g., /dashboard, /settings) and allow public access to others (e.g., /, /auth).
3. Ensure the middleware redirects unauthenticated users to the sign-in page.
4. Test the middleware to confirm it correctly restricts access and handles authentication states.
5. Verify compatibility with the sister app's SSO configuration for cross-domain access.

## Tasks / Subtasks
- [ ] Analyze existing middleware setup
  - [ ] Check for existing middleware.ts in apps/web/
  - [ ] Review current route protection logic
  - [ ] Identify routes requiring protection
- [ ] Implement Clerk authMiddleware
  - [ ] Import authMiddleware from @clerk/nextjs
  - [ ] Configure public and protected routes
  - [ ] Set up redirect URLs for authentication
- [ ] Configure route protection rules
  - [ ] Define public routes (/, /auth pages)
  - [ ] Define protected routes (/dashboard, /settings, etc.)
  - [ ] Configure SSO domain compatibility
- [ ] Test middleware functionality
  - [ ] Test protected route access control
  - [ ] Test public route accessibility
  - [ ] Test redirect behavior for unauthenticated users
- [ ] Verify SSO compatibility
  - [ ] Test cross-domain authentication
  - [ ] Confirm JWT token handling
  - [ ] Validate session sharing with sister app

## Dev Notes
**Relevant Architecture Information:**
- Next.js middleware for route protection (from tech stack)
- Clerk authMiddleware integration
- SSO support for sister app (from architecture.md)
- Netlify deployment platform (from architecture.md)
- JWT authentication for API calls

**Source Tree Information:**
- Middleware location: apps/web/middleware.ts
- App routes: apps/web/src/app/ directory structure
- Auth pages: apps/web/src/app/(auth)/ (to be created)
- Public pages: apps/web/src/app/ (landing pages)

**Technical Context:**
- Clerk's authMiddleware handles JWT validation
- Next.js middleware runs on edge/serverless
- Compatible with Netlify Functions deployment
- SSO requires domain configuration in Clerk
- Handles expired tokens and session management

## Testing
**Relevant Testing Standards from Architecture:**
- ESLint for code quality (root .eslintrc.js)
- Prettier for code formatting (root prettier.config.js)
- TypeScript for type safety across monorepo
- E2E testing for route protection

**Testing Requirements for this Story:**
- Unit tests for middleware logic
- Integration tests for Clerk authMiddleware
- E2E tests for route protection scenarios
- SSO compatibility testing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-03 | 1.0 | Initial story creation with template compliance | Sarah (PO) |

## Dev Agent Record
### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent*