# Story 4.1.13: MultiStep Form Step 3 Implementation

**Status:** Draft  
**Priority:** High  
**Estimated Effort:** 3-4 hours  
**Dependencies:** Story 4.1.12 (Step 2 Implementation) - TO BE COMPLETED

## Story

**As a** sustainability reporting user,  
**I want** to complete the GeneralInfo form with the third and final step for Business Context,  
**so that** I have a fully functional multi-step form system with complete validation, navigation, and submission capabilities matching the original 4.1.10 requirements.

## Story Context

**Strategic Approach:**
- Final incremental implementation completing the split of 4.1.10
- Adds form submission and completion functionality
- Completes the full multi-step form experience
- Validates entire TDD implementation approach

**Implementation Strategy:**
- Add Step 3 to existing two-step implementation
- Implement final submission logic
- Complete end-to-end form flow testing
- Ensure feature parity with original 4.1.10 requirements

## Acceptance Criteria

1. GeneralInfo form includes all three steps: Company Info, Strategy & Governance, Business Context
2. Step 3 includes business context fields: business model, value chain, stakeholder engagement, materiality
3. Form submission only available after completing all three steps with valid data
4. Successful submission clears localStorage and shows confirmation
5. Complete form data structure matches original 4.1.10 specification
6. Progress indicator shows all three steps with proper completion states
7. Navigation works seamlessly across all three steps with validation
8. Tests written BEFORE implementation for Step 3 and submission
9. End-to-end tests validate complete multi-step flow
10. Full TypeScript support and compilation success
11. Performance remains optimal with all three steps
12. Accessibility compliance maintained throughout form

## Tasks / Subtasks

- [ ] **Task 1: Write Tests for Step 3 and Submission (TDD)** (AC: 8)
  - [ ] Create tests for Step 3 field rendering
  - [ ] Write tests for Step 3 validation rules
  - [ ] Write tests for form submission logic
  - [ ] Write tests for localStorage clearing on submit
  - [ ] Write end-to-end flow tests
  - [ ] Verify tests fail initially (Red phase)

- [ ] **Task 2: Complete Form Configuration with Step 3** (AC: 1, 2, 5)
  - [ ] Extend GeneralInfoData interface for Step 3 fields
  - [ ] Create Zod schema for business context fields
  - [ ] Update form configuration to include Step 3
  - [ ] Ensure data structure matches original spec

- [ ] **Task 3: Implement Form Submission** (AC: 3, 4)
  - [ ] Add submission handler to form configuration
  - [ ] Implement validation for all steps before submit
  - [ ] Clear localStorage on successful submission
  - [ ] Add submission confirmation UI

- [ ] **Task 4: Finalize Navigation and Progress** (AC: 6, 7)
  - [ ] Update ProgressIndicator for three steps
  - [ ] Ensure navigation works across all steps
  - [ ] Add step completion indicators
  - [ ] Test edge cases in navigation flow

- [ ] **Task 5: Make All Tests Pass** (AC: 9, 10)
  - [ ] Fix implementation to pass Step 3 tests
  - [ ] Ensure submission tests pass
  - [ ] Verify end-to-end tests pass
  - [ ] Confirm TypeScript compilation

- [ ] **Task 6: Performance and Accessibility** (AC: 11, 12)
  - [ ] Profile form performance with all steps
  - [ ] Optimize re-renders if needed
  - [ ] Run accessibility audit
  - [ ] Fix any WCAG 2.1 AA issues

- [ ] **Task 7: Integration Verification** (AC: 1, 5, 9)
  - [ ] Verify feature parity with original 4.1.10
  - [ ] Test complete user journey
  - [ ] Document any deviations or improvements
  - [ ] Prepare for QA handoff

## Dev Notes

### Previous Story Context (4.1.11 & 4.1.12 Completion)
- Steps 1 and 2 successfully implemented with TDD
- Multi-step navigation established and tested
- localStorage persistence working across steps
- Validation and navigation patterns established

### Form Configuration Final Structure
Complete three-step configuration:
```typescript
interface GeneralInfoData {
  // Step 1: Company Information
  companyInfo: {
    name: string
    organizationNumber: string
    country: string
    naceCode: string
    industry: string
    revenue: number
    balanceSheet: number
    employees: number
    contactName: string
    contactEmail: string
  }
  // Step 2: Strategy & Governance
  strategyGovernance: {
    sustainabilityStrategy: string
    governanceStructure: string
    riskManagement: string
    initiatives: string[]
    boardOversight: string
  }
  // Step 3: Business Context
  businessContext: {
    businessModel: string
    valueChain: string
    stakeholderEngagement: string
    materialityAssessment: string
    reportingScope: 'individual' | 'consolidated'
  }
}
```

### Step 3 Fields Required
Business Context fields from original story:
- Business model and value chain description (textarea, required, min 200 chars)
- Stakeholder engagement process (textarea, required, min 100 chars)
- Materiality assessment methodology (textarea, required, min 100 chars)
- Reporting scope (radio group: individual/consolidated, required)
- Key business segments (field array, optional)

### Submission Implementation
Based on MultiStepForm patterns:
```typescript
onSubmit: async (data: GeneralInfoData) => {
  // Validate complete data structure
  // Send to API or storage
  // Clear localStorage on success
  // Show confirmation message
}
```

### File Updates Required
- Update: `apps/web/src/lib/forms/configs/general-info-config.ts`
- Update: `apps/web/src/lib/forms/types/general-info-types.ts`
- Update: `apps/web/src/lib/forms/validation/general-info-schemas.ts`
- Update: `apps/web/src/app/(SignedIn)/generalinfo/page.tsx`
- Create: `apps/web/src/app/(SignedIn)/generalinfo/__tests__/step3.test.tsx`
- Create: `apps/web/src/app/(SignedIn)/generalinfo/__tests__/submission.test.tsx`
- Create: `apps/web/src/app/(SignedIn)/generalinfo/__tests__/e2e.test.tsx`

### Performance Considerations
- Form with three steps should initialize within 500ms
- Step navigation should respond within 100ms
- Auto-save debounced at 500ms to prevent excessive writes
- Consider memoization for expensive computations

### Testing Requirements

**Test File Locations:** 
- `apps/web/src/app/(SignedIn)/generalinfo/__tests__/step3.test.tsx` - Step 3 tests
- `apps/web/src/app/(SignedIn)/generalinfo/__tests__/submission.test.tsx` - Submission tests
- `apps/web/src/app/(SignedIn)/generalinfo/__tests__/e2e.test.tsx` - End-to-end tests

**Test Standards:**
- Complete TDD cycle for Step 3
- Test full form submission flow
- Verify localStorage cleanup
- Test error handling in submission
- Validate complete data structure

**End-to-End Test Scenarios:**
- Complete form fill from Step 1 to submission
- Navigate back and forth with data preservation
- Invalid data prevents progression
- Submission only available on Step 3
- localStorage cleared after successful submit
- Reload during form fill restores correct step

### Completion Criteria
This story completes the split implementation of 4.1.10:
- All three steps implemented with TDD
- Full multi-step form functionality
- Complete test coverage
- Ready for production use

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-26 | 1.0 | Initial story creation - Final split from 4.1.10 for TDD | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled during implementation*

### Debug Log References
*To be filled during implementation*

### Completion Notes List
*To be filled during implementation*

### File List
*To be filled during implementation*

## QA Results

*QA review results will be documented here after implementation*
