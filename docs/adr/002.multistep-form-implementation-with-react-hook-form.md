# ADR 002: Multistep Form Implementation with React Hook Form and Zod

**Status**: Accepted  
**Date**: 2025-08-30  
**Decision Makers**: Development Team, Doc Brown (Documentation Specialist)  

## Context

### Problem Statement

The My Better T App project needed a robust, scalable solution for implementing complex multistep forms with proper validation, state management, and accessibility. The project required a system that could handle dynamic form fields, step navigation, validation schemas, and data persistence across steps while maintaining performance and user experience.

Key challenges included:
- Managing complex form state across multiple steps
- Implementing consistent validation with type safety
- Ensuring accessibility compliance for all form elements
- Providing a reusable pattern for different form types
- Handling performance considerations for form rendering

### Constraints and Forces

- **Technology Stack Alignment**: Must integrate with existing Next.js 15.3.0, React 19, TypeScript strict mode, and shadcn/ui component library
- **Performance Requirements**: Must follow established performance best practices, including moving regex literals to top-level scope to avoid performance issues with Biome linting rules
- **Accessibility Standards**: Must comply with WCAG 2.1 AA accessibility standards as defined in project coding standards
- **Testing Integration**: Must support TDD methodology with Vitest and React Testing Library as established in ADR 001
- **Code Quality Standards**: Must adhere to Biome formatting and ultracite standards with zero `any` types allowed
- **Existing Dependencies**: Must leverage installed libraries including React Hook Form, Zod, and TanStack Form (though TanStack Form was abandoned in favor of React Hook Form)

## Decision

**We have implemented a comprehensive multistep form system** using React Hook Form for state management and Zod for validation schemas. This combination provides efficient form handling with type safety, reusable validation patterns, and a component-based architecture that supports various form scenarios.

### Technical Approach

**Core Libraries**: 
- **React Hook Form**: Primary form state management library for efficient re-renders and built-in validation
- **Zod**: Schema validation library for type-safe validation with centralized logic

**Architecture Pattern**:
1. **Component-Based Structure**: Reusable components for different form aspects (MultiStepForm container, StepIndicator, FormNavigation, FormField)
2. **Hook-Based Logic**: Custom hooks for form state management and step navigation
3. **Schema-Driven Validation**: Zod schemas for each step with centralized validation logic
4. **Type-Safe Implementation**: TypeScript interfaces and types for all form data structures

**Key Implementation Details**:
- Form data persistence using localStorage at each step transition
- Proper validation on step transitions and form submission
- Accessibility compliance with semantic HTML and ARIA attributes
- Performance optimization with regex literals at top-level scope
- Integration with existing shadcn/ui component library

### Key Components

```
apps/web/src/components/
‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îî‚îÄ‚îÄ multi-step-form/
‚îÇ       ‚îú‚îÄ‚îÄ MultiStepForm.tsx          # Main container component
‚îÇ       ‚îú‚îÄ‚îÄ hooks/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ use-multi-step-form.ts # Custom hook for form logic
‚îÇ       ‚îî‚îÄ‚îÄ types.ts                   # Type definitions
‚îî‚îÄ‚îÄ forms/
    ‚îî‚îÄ‚îÄ sustainability/
        ‚îú‚îÄ‚îÄ InitiativeManager.tsx      # Specific form implementation
        ‚îú‚îÄ‚îÄ InitiativeForm.tsx         # Individual form step
        ‚îú‚îÄ‚îÄ InitiativesTable.tsx       # Data display component
        ‚îú‚îÄ‚îÄ __tests__/
        ‚îÇ   ‚îî‚îÄ‚îÄ InitiativeManager.validation.test.tsx # Validation tests
        ‚îú‚îÄ‚îÄ types/
        ‚îÇ   ‚îî‚îÄ‚îÄ sustainability-types.ts # Form-specific types
        ‚îî‚îÄ‚îÄ validation/
            ‚îî‚îÄ‚îÄ sustainability-schemas.ts # Zod validation schemas
```

## Consequences

### Positive Outcomes

‚úÖ **Efficient Form Management**: React Hook Form provides optimal performance with minimal re-renders  
‚úÖ **Type Safety**: Zod schemas ensure type-safe form data with runtime validation  
‚úÖ **Reusable Architecture**: Component-based structure allows for easy extension to new forms  
‚úÖ **Accessibility Compliance**: Implementation follows WCAG 2.1 AA standards with proper semantic HTML  
‚úÖ **Performance Optimization**: Regex literals moved to top-level scope to satisfy Biome linting rules  
‚úÖ **Test Coverage**: Comprehensive test coverage for form validation and user interactions  
‚úÖ **Data Persistence**: Form data saved to localStorage at each step for user experience  

### Negative Outcomes

‚ö†Ô∏è **Learning Curve**: Team members need to learn React Hook Form and Zod patterns  
‚ö†Ô∏è **Dependency on Libraries**: Implementation tied to React Hook Form and Zod ecosystems  
‚ö†Ô∏è **Complexity for Simple Forms**: May be overkill for single-step forms  

### Risks

üö® **Library Updates**: Future updates to React Hook Form or Zod may require refactoring  
üö® **Performance with Large Forms**: Very complex forms with many fields may require additional optimization  
üö® **Validation Complexity**: Nested or conditional validation rules may become difficult to maintain  

## Implementation Details

### Dependencies

```json
{
  "dependencies": {
    "react-hook-form": "^7.50.0",
    "zod": "^3.22.0"
  }
}
```

### Configuration

**Form Hook Implementation** (`apps/web/src/components/common/multi-step-form/hooks/use-multi-step-form.ts`):
```typescript
export function useMultiStepForm({ onSubmit }: UseMultiStepFormProps = {}) {
  // Form state management with React Hook Form
  const form = useForm<FormDataType>({
    resolver: zodResolver(currentStepConfig.schema),
    defaultValues: currentStepConfig.defaultValues,
  });
  
  // Step navigation logic
  const goToStep = (stepIndex: number) => {
    // Validation and navigation logic
  };
  
  // Form submission handling
  const handleSubmit = (data: FormDataType) => {
    // Submission logic with localStorage persistence
  };
}
```

**Validation Schema** (`apps/web/src/lib/forms/validation/sustainability-schemas.ts`):
```typescript
import { z } from 'zod';

export const sustainabilityInitiativeSchema = z.object({
  type: z.enum(['Climate Change', 'Workforce Development', 'Human Rights', 'Anti-Corruption', 'Biodiversity']),
  responsiblePerson: z.string().min(2, 'Responsible person name must be at least 2 characters'),
  goal: z.string().min(10, 'Goal must be at least 10 characters'),
  description: z.string().min(20, 'Description must be at least 20 characters'),
});
```

### Performance Considerations

**Regex Optimization**: All regex literals moved to top-level scope in test files to avoid performance issues with Biome linting rule `performance/useTopLevelRegex`:

```typescript
// Define regex constants at the top of the file
const ADD_WORKFORCE_DEV_REGEX = /add Workforce Development/i
const RESPONSIBLE_PERSON_ERROR_REGEX = /Responsible person name must be at least 2 characters/i

// Use constants in tests
const addButton = screen.getByRole('button', { name: ADD_WORKFORCE_DEV_REGEX })
expect(screen.getByText(RESPONSIBLE_PERSON_ERROR_REGEX)).toBeInTheDocument()
```

**Form Performance**: 
- Efficient re-renders using React Hook Form's optimized state management
- Memoization of expensive computations where appropriate
- localStorage persistence to maintain form state across sessions

### Key Files and Locations

**Core Implementation**:
- `apps/web/src/components/common/multi-step-form.tsx` - Main multistep form container
- `apps/web/src/components/common/multi-step-form/hooks/use-multi-step-form.ts` - Custom hook for form logic
- `apps/web/src/components/common/multi-step-form/types.ts` - Type definitions

**Sustainability Form Implementation**:
- `apps/web/src/components/forms/sustainability/InitiativeManager.tsx` - Main form component
- `apps/web/src/components/forms/sustainability/InitiativeForm.tsx` - Individual form step
- `apps/web/src/components/forms/sustainability/InitiativesTable.tsx` - Data display
- `apps/web/src/lib/forms/validation/sustainability-schemas.ts` - Zod validation schemas
- `apps/web/src/lib/forms/types/sustainability-types.ts` - Type definitions

**Test Files**:
- `apps/web/src/components/forms/sustainability/__tests__/InitiativeManager.validation.test.tsx` - Validation tests

## Validation

### Success Metrics

**Immediate Validation (Completed)**:
- ‚úÖ Multistep form system implemented with React Hook Form and Zod
- ‚úÖ Form validation working with proper error messages
- ‚úÖ Data persistence across steps using localStorage
- ‚úÖ Accessibility compliance with semantic HTML and ARIA attributes
- ‚úÖ Performance optimization with regex literals at top-level scope
- ‚úÖ Comprehensive test coverage for form validation
- ‚úÖ Integration with existing shadcn/ui component library

**Ongoing Validation Metrics**:
- **Form Usage**: Track adoption of multistep form pattern across different features
- **Performance Monitoring**: Monitor form rendering performance and user experience
- **Accessibility Audits**: Regular accessibility testing of form components
- **Code Quality**: Maintain Biome and TypeScript standards
- **Test Coverage**: Ensure test coverage remains above 80% for form components

### Review Triggers

- **Quarterly**: Assess form pattern adoption and developer feedback
- **Library Updates**: When React Hook Form or Zod release major versions
- **Performance Issues**: If form rendering performance degrades
- **Accessibility Violations**: If accessibility issues are identified in form components

## References

### Core Documentation
- [Technology Stack Reference](../reference/tech-stack.md)
- [Coding Standards](../reference/coding-standards.md)
- [TDD Process Guide](../reference/tdd-process-guide.md)

### Implementation Files
- `apps/web/src/components/common/multi-step-form.tsx`
- `apps/web/src/components/common/multi-step-form/hooks/use-multi-step-form.ts`
- `apps/web/src/components/forms/sustainability/InitiativeManager.tsx`
- `apps/web/src/lib/forms/validation/sustainability-schemas.ts`

### Related Documentation
- [Regex Linting Best Practice](../handover/regex-linting-best-practice.md)
- [Multistep Form Implementation Report](../handover/multistep-form-implementation-report.md)

## Review Schedule

**Next Review**: Q1 2026 (6 months post-implementation)

**Review Criteria**:
- Adoption rate of multistep form pattern across the application
- Performance metrics and user feedback
- Accessibility compliance status
- Maintenance overhead and developer experience